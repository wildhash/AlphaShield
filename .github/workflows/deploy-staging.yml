name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests before deploy
        run: pytest tests/ -v --tb=short -x

      - name: Build Docker image
        run: |
          docker build -t alphashield:${{ github.sha }} .
          docker tag alphashield:${{ github.sha }} alphashield:staging

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to registry
        run: |
          docker tag alphashield:staging ghcr.io/${{ github.repository_owner }}/alphashield:staging
          docker push ghcr.io/${{ github.repository_owner }}/alphashield:staging

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "Image: ghcr.io/${{ github.repository_owner }}/alphashield:staging"
          # Add your deployment commands here:
          # - SSH to staging server
          # - Pull latest image
          # - Restart services
          # Example:
          # ssh ${{ secrets.STAGING_HOST }} "docker pull ghcr.io/${{ github.repository_owner }}/alphashield:staging && docker-compose up -d"

      - name: Run health check
        run: |
          echo "üè• Running health checks..."
          # Add health check commands here
          # Example: curl -f https://staging.alphashield.io/health

      - name: Notify deployment
        run: |
          echo "‚úÖ Staging deployment complete!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
